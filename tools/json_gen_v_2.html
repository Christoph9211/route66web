<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Products.json Manager</title>
    <style>
      :root {
        --primary: #0d6efd;       /* bright blue */
        --primary-dark: #084298;  /* darker blue for hover / headers */
        --danger: #b91c1c;        /* deep red */
        --gray-200: #cbd5e1;      /* darker light‑gray for better border contrast */
        --gray-600: #334155;      /* text gray */
        --white: #ffffff;
      }
      * {
        box-sizing: border-box;
      }
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica,
          Arial, sans-serif;
        margin: 1rem auto;
        max-width: 900px;
        padding: 0 1rem;
        color: var(--gray-600);
        background: var(--white);
      }
      h1,
      h2 {
        text-align: center;
        color: var(--primary-dark);
      }
      .btn {
        display: inline-block;
        cursor: pointer;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        border: none;
        background: var(--primary);
        color: var(--white);
        transition: background 0.15s ease-in-out;
      }
       .btn:hover,
      .btn:focus-visible {
        background: var(--primary-dark);
        outline: none;
      }
      .btn-danger {
        background: var(--danger);
      }
      .btn-danger:hover,
      .btn-danger:focus-visible {
        background: #7f1d1d;
      }
      .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
      }

      /* Form controls */
      .form-group {
        margin-bottom: 0.75rem;
      }
      label {
        font-weight: 600;
        display: block;
        margin-bottom: 0.25rem;
        color: var(--primary-dark);
      }
      input[type='text'],
      input[type='number'],
      textarea,
      select {
        width: 100%;
        border: 1px solid var(--gray-200);
        border-radius: 0.375rem;
        padding: 0.5rem;
        font: inherit;
        color: var(--gray-600);
      }
      input:focus,
      textarea:focus,
      select:focus {
        outline: 2px solid var(--primary);
        outline-offset: 1px;
      }
      textarea {
        resize: vertical;
      }

      /* Tables */
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        border: 1px solid var(--gray-200);
        padding: 0.5rem;
        text-align: left;
      }
      th {
        background: var(--primary-dark);
        color: var(--white);
      }

      .actions {
        display: flex;
        gap: 0.25rem;
      }
      .hidden {
        display: none !important;
      }
      /* — Sticky header — */
      #products-table thead th {
        position: sticky;
        top: 0;                         /* keep header at top while scrolling */
        background: var(--primary-dark);/* retain existing colour */
        z-index: 1;                     /* stay above table rows */
      }
    </style>
  </head>
  <body>
    <h1>Products.json Manager</h1>

    <div style="text-align: center; margin-bottom: 1rem">
      <input
        id="file-input"
        type="file"
        accept="application/json"
        class="hidden"
      />
      <button id="load-btn" class="btn">Import products.json</button>
      <button id="download-all-btn" class="btn" disabled>
        Download updated JSON
      </button>
      <button id="download-csv-btn" class="btn" disabled>
        Download updated CSV
      </button>
    </div>

    <h2 id="form-title">Add New Product</h2>
    <form id="product-form" autocomplete="on">
      <div class="form-group">
        <label for="name">Name</label>
        <input id="name" name="name" type="text" required />
      </div>

      <div class="form-group">
        <label for="category">Category</label>
        <select id="category" name="category" required>
          <option value="Concentrates">Concentrates</option>
          <option value="Diamonds & Sauce">Diamonds & Sauce</option>
          <option value="Edibles">Edibles</option>
          <option value="Flower">Flower</option>
          <option value="Pre-Rolls">Pre-Rolls</option>
          <option value="Vapes & Carts">Vapes & Carts</option>
        </select>
        <!-- <input
          id="category"
          name="category"
          type="text"
          list="category-list"
          required
        /> -->
        <datalist id="category-list"></datalist>
      </div>

      <!-- Size / Price grid -->
      <div id="size-price-section" class="form-group">
        <label>Sizes & Prices</label>
        <div style="display: flex; gap: 0.5rem; align-items: flex-end; flex-wrap: wrap;">
          <div style="flex: 1 1 150px; min-width: 120px;">
            <label for="size-input">Size</label>
            <input id="size-input" type="text" placeholder="1 gram" />
          </div>
          <div style="flex: 1 1 150px; min-width: 120px;">
            <label for="price-input">Price ($)</label>
            <input id="price-input" type="number" step="0.01" placeholder="10.00" />
          </div>
          <button type="button" id="add-size-btn" class="btn btn-sm" style="height: 2.5rem;">+</button>
        </div>
        <table id="size-price-table" style="margin-top: 0.5rem;" class="hidden">
          <thead>
            <tr><th>Size</th><th>Price ($)</th><th style="width: 1px;"></th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="form-group">
        <label for="thca">THCa % (optional)</label>
        <input id="thca" name="thca" type="number" step="0.01" />
      </div>

      <div class="form-group">
        <label for="banner">Banner Flag (optional)</label>
        <select id="banner" name="banner">
          <option value="">-- none --</option>
          <option value="Out of Stock">Out of Stock</option>
          <option value="Coming Soon">Coming Soon</option>
          <option value="New">New</option>
          <option value="Special">Special</option>
        </select>
      </div>

      <div class="form-group">
        <label for="availability">Availability {"JSON object": true} or {"JSON object": false} (only for "Vapes & Carts" and "Pre-Rolls")</label>
        <textarea
          id="availability"
          name="availability"
          rows="2"
          placeholder='{"Super Boof": true}'
        ></textarea>
      </div>

      <div style="text-align: center; margin-top: 1rem">
        <button type="submit" id="submit-btn" class="btn">
          Add Product
        </button>
        <button type="reset" id="cancel-edit-btn" class="btn hidden">
          Cancel
        </button>
      </div>
    </form>

    <h2>Current Products</h2>
    <table id="products-table" class="hidden">
      <thead>
        <tr>
          <th>#</th>
          <th>Name</th>
          <th>Category</th>
          <th>Sizes</th>
          <th>Prices</th>
          <th>Banner</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <script>
      // ------------------ State & Constants ------------------
      const products = []
      let editIndex = null
      const LOCAL_KEY = 'products'

      // Size‑price temp list for current form session
      let sizePricePairs = [] // [{size, price}]

      // ------------------ DOM Refs ------------------
      const fileInput = document.getElementById('file-input')
      const loadBtn = document.getElementById('load-btn')
      const downloadAllBtn = document.getElementById('download-all-btn')
      const downloadCsvBtn = document.getElementById('download-csv-btn')
      const form = document.getElementById('product-form')
      const table = document.getElementById('products-table')
      const tbody = table.querySelector('tbody')
      const categoryList = document.getElementById('category-list')
      const formTitle = document.getElementById('form-title')
      const submitBtn = document.getElementById('submit-btn')
      const cancelEditBtn = document.getElementById('cancel-edit-btn')

      // size‑price specific refs
      const sizeInput = document.getElementById('size-input')
      const priceInput = document.getElementById('price-input')
      const addSizeBtn = document.getElementById('add-size-btn')
      const sizePriceTable = document.getElementById('size-price-table')
      const sizePriceTbody = sizePriceTable.querySelector('tbody')

      // Default categories for datalist
      const defaultCategories = [
        'Concentrates',
        'Diamonds & Sauce',
        'Edibles',
        'Flower',
        'Pre-Rolls',
        'Vapes & Carts',
      ]

      // ------------------ Utility Helpers ------------------
      const getRank = (p) => {
        if (p.banner === 'New') return 0
        if (p.banner === 'Out of Stock') return 2
        return 1
      }

      const parsePrices = (str) => {
        const obj = {}
        str
          .split(/\n|\r/) // keep for JSON imports
          .map((l) => l.trim())
          .filter(Boolean)
          .forEach((l) => {
            const [key, val] = l.split('=')
            if (key && val) obj[key.trim()] = parseFloat(val.trim())
          })
        return obj
      }

      const stringifyPrices = (obj) =>
        Object.entries(obj)
          .map(([k, v]) => `${k}=${v}`)
          .join('\n')

      const refreshCategoryList = () => {
        categoryList.innerHTML = ''
        const categories = new Set([
          ...defaultCategories,
          ...products.map((p) => p.category),
        ])
        Array.from(categories)
          .sort()
          .forEach((cat) => {
            const option = document.createElement('option')
            option.value = cat
            categoryList.appendChild(option)
          })
      }

      // Persist products to localStorage (helper)
      const persistToLocalStorage = () => {
        try {
          localStorage.setItem(LOCAL_KEY, JSON.stringify(products))
        } catch (err) {
          console.error('Unable to save to localStorage', err)
        }
      }

      // Attempt to auto‑save to a file using the File System Access API
      const autoSaveToFile = async () => {
        persistToLocalStorage()
        if (!('showSaveFilePicker' in window)) return
        try {
          if (navigator.storage && navigator.storage.persist) {
            await navigator.storage.persist()
          }
          const handle = await showSaveFilePicker({
            suggestedName: 'products.json',
            types: [
              {
                description: 'JSON file',
                accept: { 'application/json': ['.json'] },
              },
            ],
          })
          const writable = await handle.createWritable()
          await writable.write(JSON.stringify(products, null, 2))
          await writable.close()
        } catch (err) {
          console.log('Auto‑save skipped', err)
        }
      }

      // Hydrate products from localStorage on page‑load (if available)
      const hydrateFromLocalStorage = () => {
        const stored = localStorage.getItem(LOCAL_KEY)
        if (!stored) return
        try {
          const data = JSON.parse(stored)
          if (Array.isArray(data)) {
            products.splice(0, products.length, ...data)
            refreshCategoryList()
            renderTable()
          }
        } catch (err) {
          console.error('Failed to parse stored products', err)
        }
      }

      // ------------------ Size‑Price Grid Rendering ------------------
      const renderSizePriceTable = () => {
        if (sizePricePairs.length === 0) {
          sizePriceTable.classList.add('hidden')
          sizePriceTbody.innerHTML = ''
          return
        }
        sizePriceTable.classList.remove('hidden')
        sizePriceTbody.innerHTML = ''
        sizePricePairs.forEach((sp, idx) => {
          const row = document.createElement('tr')
          row.innerHTML = `<td>${sp.size}</td><td>$${sp.price.toFixed(
            2
          )}</td><td><button class="btn btn-sm btn-danger" data-spidx="${idx}">✕</button></td>`
          sizePriceTbody.appendChild(row)
        })
      }

      // ------------------ Size‑Price Events ------------------
      addSizeBtn.addEventListener('click', () => {
        const size = sizeInput.value.trim()
        const priceVal = priceInput.value.trim()
        const price = parseFloat(priceVal)
        if (!size) return alert('Please enter a size label')
        if (!priceVal || isNaN(price)) return alert('Please enter a valid price')
        // Prevent duplicates
        if (sizePricePairs.some((p) => p.size === size)) {
          return alert('Size already added!')
        }
        sizePricePairs.push({ size, price })
        sizeInput.value = ''
        priceInput.value = ''
        renderSizePriceTable()
      })

      sizePriceTbody.addEventListener('click', (e) => {
        const delBtn = e.target.closest('button[data-spidx]')
        if (!delBtn) return
        const idx = parseInt(delBtn.dataset.spidx, 10)
        sizePricePairs.splice(idx, 1)
        renderSizePriceTable()
      })

      // ------------------ Products Table Rendering ------------------
      const renderTable = () => {
        products.sort((a, b) => {
          const ra = getRank(a)
          const rb = getRank(b)
          if (ra !== rb) return ra - rb
          return a.name.localeCompare(b.name, undefined, {
            sensitivity: 'base',
          })
        })

        persistToLocalStorage()

        if (products.length === 0) {
          table.classList.add('hidden')
          downloadAllBtn.disabled = true
          downloadCsvBtn.disabled = true
          return
        }

        table.classList.remove('hidden')
        downloadAllBtn.disabled = false
        downloadCsvBtn.disabled = false

        tbody.innerHTML = ''
        products.forEach((p, idx) => {
          const tr = document.createElement('tr')
          tr.innerHTML = `
            <td>${idx + 1}</td>
            <td>${p.name}</td>
            <td>${p.category}</td>
            <td>${p.size_options.join(', ')}</td>
            <td>${Object.entries(p.prices)
              .map(([k, v]) => `${k}: $${v}`)
              .join('<br>')}</td>
            <td>${p.banner || ''}</td>
            <td class="actions">
              <button class="btn btn-sm" data-action="edit" data-idx="${idx}">Edit</button>
              <button class="btn btn-sm btn-danger" data-action="delete" data-idx="${idx}">Delete</button>
            </td>`
          tbody.appendChild(tr)
        })
      }

      // ------------------ Import JSON ------------------
      loadBtn.addEventListener('click', () => fileInput.click())

      fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0]
        if (!file) return
        const reader = new FileReader()
        reader.onload = (ev) => {
          try {
            const data = JSON.parse(ev.target.result)
            if (!Array.isArray(data)) throw new Error('JSON root must be array')
            products.splice(0, products.length, ...data)
            refreshCategoryList()
            renderTable()
            alert(`Loaded ${data.length} products.`)
          } catch (err) {
            alert('Failed to parse JSON: ' + err.message)
          }
        }
        reader.readAsText(file)
      })

      // ------------------ Export JSON ------------------
      downloadAllBtn.addEventListener('click', () => {
        const blob = new Blob([JSON.stringify(products, null, 2)], {
          type: 'application/json',
        })
        const url = URL.createObjectURL(blob)
        const a = document.createElement('a')
        a.href = url
        a.download = 'products.json'
        a.click()
        URL.revokeObjectURL(url)
      })

      // ------------------ Export CSV ------------------
      downloadCsvBtn.addEventListener('click', () => {
        const sorted = [...products].sort((a, b) => {
          const ra = getRank(a)
          const rb = getRank(b)
          if (ra !== rb) return ra - rb
          return a.name.localeCompare(b.name, undefined, {
            sensitivity: 'base',
          })
        })

        const header = [
          'Name',
          'Category',
          'Size',
          'Price ($)',
          'THCA (%)',
          'Banner',
        ]
        const lines = [header.join(',')]

        const escapeCsv = (val) => {
          if (val === null || val === undefined) return ''
          const str = String(val)
          return str.includes(',') || str.includes('"') || str.includes('\n')
            ? `"${str.replace(/\"/g, '""')}"`
            : str
        }

        sorted.forEach((p) => {
          p.size_options.forEach((size) => {
            const priceRaw = p.prices[size]
            const price = typeof priceRaw === 'number' ? priceRaw.toFixed(2) : priceRaw || ''
            const row = [
              p.name,
              p.category,
              size,
              price,
              p.thca_percentage ?? '',
              p.banner ?? '',
            ].map(escapeCsv)
            lines.push(row.join(','))
          })
        })

        const csvStr = lines.join('\n')
        const blob = new Blob([csvStr], { type: 'text/csv' })
        const url = URL.createObjectURL(blob)
        const a = document.createElement('a')
        a.href = url
        a.download = 'products.csv'
        a.click()
        URL.revokeObjectURL(url)
      })

      // ------------------ Form Submit ------------------
      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        // 1. Gather the basics
        const name      = form.name.value.trim();
        const category  = form.category.value.trim();
        const thcaRaw   = form.thca.value.trim();
        const bannerVal = form.banner.value;
        const availabilityRaw = form.availability.value.trim();

        // 2. Convert the size/price grid into the structure we store
        const sizeOptions = sizePricePairs.map(p => p.size);
        const prices      = Object.fromEntries(
                              sizePricePairs.map(p => [p.size, p.price])
                            );

        // 3. Build the product record
        const product = { name, category, size_options: sizeOptions, prices };
        if (thcaRaw)  product.thca_percentage = parseFloat(thcaRaw);
        if (bannerVal) product.banner        = bannerVal;
        if (availabilityRaw) {
          try { product.availability = JSON.parse(availabilityRaw); }
          catch { return alert('Availability must be valid JSON'); }
        }

        // 4. Insert or update
        if (editIndex !== null) products[editIndex] = product;
        else                    products.push(product);

        // 5. House-keeping
        refreshCategoryList();
        renderTable();
        form.reset();
        sizePricePairs = [];            // clear the grid for the next entry
        renderSizePriceTable();
        form.banner.value = '';
        editIndex = null;
        submitBtn.textContent = 'Add Product';
        formTitle.textContent = 'Add New Product';
        cancelEditBtn.classList.add('hidden');

        await autoSaveToFile();
      });

      // ------------------ Table Actions ------------------
      tbody.addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-action]')
        if (!btn) return
        const idx = parseInt(btn.dataset.idx, 10)
        const action = btn.dataset.action

        if (action === 'delete') {
          if (confirm(`Delete product "${products[idx].name}"?`)) {
            products.splice(idx, 1)
            renderTable()
          }
          return
        }
        if (action === 'edit') {
          const prod = products[idx];
        
          // 1. Basic fields
          form.name.value        = prod.name;
          form.category.value    = prod.category;
          form.thca.value        = prod.thca_percentage ?? '';
          form.banner.value      = prod.banner ?? '';
          form.availability.value =
            prod.availability ? JSON.stringify(prod.availability, null, 2) : '';
        
          // 2. Rebuild the size/price grid
          sizePricePairs = prod.size_options.map(sz => ({
            size:  sz,
            price: prod.prices[sz]
          }));
          renderSizePriceTable();
        
          // 3. Switch the UI to “editing” mode
          editIndex = idx;
          submitBtn.textContent = 'Save Changes';
          formTitle.textContent = `Edit Product (#${idx + 1})`;
          cancelEditBtn.classList.remove('hidden');
        }
      })

      // ------------------ Cancel Edit ------------------
      cancelEditBtn.addEventListener('click', () => {
        form.reset()
        form.banner.value = ''
        editIndex = null
        submitBtn.textContent = 'Add Product'
        formTitle.textContent = 'Add New Product'
        cancelEditBtn.classList.add('hidden')
      })

      // ------------------ Init ------------------
      hydrateFromLocalStorage()
    </script>
  </body>
</html>
